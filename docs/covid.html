<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AY.29</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script>
    // JIS X 0401
    const pref47 = {
      Hokkaido:   { code: 1,  area: "東北", label: "北海道" },
      Aomori:     { code: 2,  area: "東北", label: "青森県" },
      Iwate:      { code: 3,  area: "東北", label: "岩手県" },
      Miyagi:     { code: 4,  area: "東北", label: "宮城県" },
      Akita:      { code: 5,  area: "東北", label: "秋田県" },
      Yamagata:   { code: 6,  area: "東北", label: "山形県" },
      Fukushima:  { code: 7,  area: "東北", label: "福島県" },
      Ibaraki:    { code: 8,  area: "関東", label: "茨城県" },
      Tochigi:    { code: 9,  area: "関東", label: "栃木県" },
      Gunma:      { code: 10, area: "関東", label: "群馬県" },
      Saitama:    { code: 11, area: "関東", label: "埼玉県" },
      Chiba:      { code: 12, area: "関東", label: "千葉県" },
      Tokyo:      { code: 13, area: "関東", label: "東京都" },
      Kanagawa:   { code: 14, area: "関東", label: "神奈川県" },
      Niigata:    { code: 15, area: "北陸", label: "新潟県" },
      Toyama:     { code: 16, area: "北陸", label: "富山県" },
      Ishikawa:   { code: 17, area: "北陸", label: "石川県" },
      Fukui:      { code: 18, area: "北陸", label: "福井県" },
      Yamanashi:  { code: 19, area: "東海", label: "山梨県" },
      Nagano:     { code: 20, area: "東海", label: "長野県" },
      Gifu:       { code: 21, area: "東海", label: "岐阜県" },
      Shizuoka:   { code: 22, area: "東海", label: "静岡県" },
      Aichi:      { code: 23, area: "東海", label: "愛知県" },
      Mie:        { code: 24, area: "東海", label: "三重県" },
      Shiga:      { code: 25, area: "関西", label: "滋賀県" },
      Kyoto:      { code: 26, area: "関西", label: "京都府" },
      Osaka:      { code: 27, area: "関西", label: "大阪府" },
      Hyogo:      { code: 28, area: "関西", label: "兵庫県" },
      Nara:       { code: 29, area: "関西", label: "奈良県" },
      Wakayama:   { code: 30, area: "関西", label: "和歌山県" },
      Tottori:    { code: 31, area: "中国", label: "鳥取県" },
      Shimane:    { code: 32, area: "中国", label: "島根県" },
      Okayama:    { code: 33, area: "中国", label: "岡山県" },
      Hiroshima:  { code: 34, area: "中国", label: "広島県" },
      Yamaguchi:  { code: 35, area: "中国", label: "山口県" },
      Tokushima:  { code: 36, area: "四国", label: "徳島県" },
      Kagawa:     { code: 37, area: "四国", label: "香川県" },
      Ehime:      { code: 38, area: "四国", label: "愛媛県" },
      Kochi:      { code: 39, area: "四国", label: "高知県" },
      Fukuoka:    { code: 40, area: "九州", label: "福岡県" },
      Saga:       { code: 41, area: "九州", label: "佐賀県" },
      Nagasaki:   { code: 42, area: "九州", label: "長崎県" },
      Kumamoto:   { code: 43, area: "九州", label: "熊本県" },
      Oita:       { code: 44, area: "九州", label: "大分県" },
      Miyazaki:   { code: 45, area: "九州", label: "宮崎県" },
      Kagoshima:  { code: 46, area: "九州", label: "鹿児島県" },
      Okinawa :   { code: 47, area: "九州", label: "沖縄県" },
    };

    /*
      Parameters
    */
    //const canvas = {"width": 7680, "height": 4320}
    //const canvas = {"width": 7680, "height": 1000}
    const canvas = {"width": 2500, "height": 1000}
    const margin = {"top": 50, "bottom": 90, "left": 90, "right": 10}

    // All data
    const tsv = "ay29.tsv"

    //const color = d3.scaleOrdinal(d3.schemeDark2);
    const color = d3.scaleOrdinal(d3.schemeTableau10);

    /*
      Code
    */
    const data = { haplotypes: new Set() };

    d3.tsv(tsv, row => {
      data.haplotypes.add(row.haplotype);
      return {
        haplotype: row.haplotype,
        firstday: Date.parse(row.first),
        lastday: Date.parse(row.last),
        duration: parseInt(row.duration),
        total: parseInt(row.total),
        prefecture: row.prefecture
      }
    }).then(dataset => {
      data.points = dataset;
      scaleX.domain([
        d3.min(dataset, d => d.firstday),
        d3.max(dataset, d => d.lastday)
      ]);
      scaleY.domain(d3.extent(dataset, d => pref47[d.prefecture].code));
      draw();
    });

    const scaleX = d3.scaleTime().range([margin.left + margin.right, canvas.width - (margin.left + margin.right)]);
    const scaleY = d3.scaleLinear().range([canvas.height - (margin.top + margin.bottom), margin.top + margin.bottom]);

    function draw() {
      addEventHandlers();
      createHaplotypeMenu();
      drawArea();
      drawAxes();
      drawHaplolink();
      drawDumbell(4, 2);
      drawTooltips();
    }

    function drawArea() {
      areas = [
        {
          name: "tohoku",
          y1: scaleY(48 - pref47["Hokkaido"].code),
          y2: scaleY(48 - pref47["Fukushima"].code - 1)
        },
        {
          name: "kanto",
          y1: scaleY(48 - pref47["Ibaraki"].code),
          y2: scaleY(48 - pref47["Kanagawa"].code - 1)
        },
        {
          name: "hokuriku",
          y1: scaleY(48 - pref47["Niigata"].code),
          y2: scaleY(48 - pref47["Fukui"].code - 1)
        },
        {
          name: "tokai",
          y1: scaleY(48 - pref47["Yamanashi"].code),
          y2: scaleY(48 - pref47["Mie"].code - 1)
        },
        {
          name: "kansai",
          y1: scaleY(48 - pref47["Shiga"].code),
          y2: scaleY(48 - pref47["Wakayama"].code - 1)
        },
        {
          name: "chugoku",
          y1: scaleY(48 - pref47["Tottori"].code),
          y2: scaleY(48 - pref47["Yamaguchi"].code - 1)
        },
        {
          name: "shikoku",
          y1: scaleY(48 - pref47["Tokushima"].code),
          y2: scaleY(48 - pref47["Kochi"].code - 1)
        },
        {
          name: "kyushu",
          y1: scaleY(48 - pref47["Fukuoka"].code),
          y2: scaleY(48 - pref47["Okinawa"].code - 1)
        }
      ]
      for (let area of areas) {
        d3.select("svg")
          .append("rect")
          .attr("class", "area")
          .attr("x", margin.left)
          .attr("y", area.y1 + (scaleY(2) - scaleY(1)) / 2)
          .attr("width", canvas.width - (margin.left + margin.right))
          .attr("height", area.y2 - area.y1)
          .attr("fill", color(area.name));
      }
    }

    function drawAxes() {
      const axisX = d3.axisBottom(scaleX)
        .tickSize(canvas.height - (margin.top + margin.bottom) * 2 + 10)
        .tickPadding(5)
        .ticks(200)
        .tickFormat(d3.timeFormat("%Y-%m-%d"));
      const axisY = d3.axisLeft(scaleY)
        .tickSize(canvas.width - (margin.left + margin.right) * 2 + 10)
        .tickPadding(5)
        .ticks(50, "c")
        .tickFormat(d => {
          for (let pref in pref47) {
            if (pref47[pref].code == 48 - d) {
              return pref47[pref].label
            }
          }
        });
      // X axis label and grid
      const xG = d3.select("svg")
            .append("g")
            .attr("class", "x-axis")
//            .attr("transform", `translate(${[0, (margin.top + margin.bottom)]})`)
            .attr("transform", `translate(${[5, (margin.top + margin.bottom)]})`)
            .call(axisX)
            .selectAll("text")     // rotate X label
            .style("text-anchor", "start")
            .attr("transform", "rotate(90)")
            .attr("x", canvas.height - (margin.bottom + margin.top) * 2)
            .attr("y", 0)
            .attr("dx", "1em")     // border
            .attr("dy", ".35em");  // base line
      // Y axis label and grid
      const yG = d3.select("svg")
            .append("g")
            .attr("class", "y-axis")
            .attr("transform", `translate(${[canvas.width - (margin.left + margin.right), 0]})`)
            .call(axisY);
      // X axis caption
      d3.select("svg")
        .append("text")
        .attr("class", "label")
        .text("Date")
      //.attr("transform", `translate(${[canvas.width / 2, canvas.height - 3]})`);
        .attr("transform", `translate(${[canvas.width / 2, canvas.height - 3]})`);
      // Y axis caption
      d3.select("svg")
        .append("text")
        .attr("class", "label")
        .text("Prefecture")
        .attr("transform", `translate(${[10, canvas.height / 2]}) rotate(-90)`);
    }

    function drawHaplolink() {
      wipeHaplolink();
      let haplotypes = data.haplotypes;
      let haplotype = d3.select("#haplotype").node().value;
      if (haplotype == "All") {
        haplotypes = data.haplotypes;
      } else {
        haplotypes = [ haplotype ];
      }
/*
      let haplotypes = d3.select("#haplotype").nodes().value;
      if (haplotypes.include("All")) {
        haplotypes = data.haplotypes;
      }
*/
      for (let haplotype of haplotypes) {
        let haplopoints = data.points.filter(d => d.haplotype == haplotype);
        d3.select("svg")
          .append("path")
          .datum(haplopoints)
          .join("path")
          .attr("class", "haplolink")
          .attr("fill", "none")
          .attr("stroke", d3.rgb("#cccccc"))
          .attr("d", haplolink(haplopoints));
      }
    }

    function wipeHaplolink() {
      d3.selectAll(".haplolink").remove();
    }

    function haplolink() {
      return d3.line()
        .x(d => scaleX(d.firstday))
        .y(d => scaleY(48 - pref47[d.prefecture].code));
    }

    function drawDumbell(r, w) {
      drawDuration(w);
      drawFirstday(r);
      drawLastday(r);
    }

    function drawFirstday(r) {
      d3.select("svg")
        .selectAll("circle.firstday")
        .data(data.points)
        .join("circle")
        .attr("class", "firstday")
        .attr("r", r)
        .attr("cx", d => scaleX(d.firstday))
        .attr("cy", d => scaleY(48 - pref47[d.prefecture].code))
//        .on("click", toggleHaplotype)
        .on("mouseover", showTooltips)
        .on("mouseleave", hideTooltips);
      d3.selectAll(".firstday")
        .style("fill", d => color(d.haplotype));
      showAllOrSelected(".firstday");
    }

    function drawLastday(r) {
      d3.select("svg")
        .selectAll("circle.lastday")
        .data(data.points)
        .join("circle")
        .attr("class", "lastday")
        .attr("r", r)
        .attr("cx", d => scaleX(d.lastday))
        .attr("cy", d => scaleY(48 - pref47[d.prefecture].code))
        .on("mouseover", showTooltips)
        .on("mouseleave", hideTooltips);
      d3.selectAll(".lastday")
        .style("fill", d => color(d.haplotype));
      hideAll(".lastday");
    }

    function drawDuration(w) {
      for (let point of data.points) {
        d3.select("svg")
          .append("path")
          .datum(point)
          .attr("class", "duration")
          .attr("fill", "none")
          .attr("stroke", color(point.haplotype))
          //.attr("stroke-width", w)
          .attr("stroke-width", d => Math.log(d.total))
          .attr("d", duration(point));
      }
      hideAll(".duration");
    }

    function duration(d) {
      x1 = scaleX(d.firstday);
      x2 = scaleX(d.lastday);
      y = scaleY(48 - pref47[d.prefecture].code);
      return d3.line()([[x1,y], [x2,y]]);
    }

    function drawTooltips() {
      const tooltip = d3.select("svg")
            .append("g")
            .attr("class", "tooltip")
            .attr("opacity", 0)
      tooltip.append("rect")
        .attr("width", 80)
        .attr("height", 120)
        .attr("rx", 5).attr("ry", 5)
        .attr("x", 5).attr("y", -5)
      tooltip.append("text").attr("class", "tt_haplotype")
        .attr("x", 10).attr("y", 10);
      tooltip.append("text").attr("class", "tt_prefecture")
        .attr("x", 10).attr("y", 30);
      tooltip.append("text").attr("class", "tt_firstday")
        .attr("x", 10).attr("y", 50);
      tooltip.append("text").attr("class", "tt_lastday")
        .attr("x", 10).attr("y", 70);
      tooltip.append("text").attr("class", "tt_duration")
        .attr("x", 10).attr("y", 90);
      tooltip.append("text").attr("class", "tt_total")
        .attr("x", 10).attr("y", 110);
    }

    function showTooltips(d) {
      d3.select(".tooltip").attr("opacity", 1)
        .attr("transform", `translate(${[scaleX(d.firstday), scaleY(48 - pref47[d.prefecture].code) - 120]})`);
      const labels = [
        d3.select(".tooltip .tt_haplotype")
          .text(`Haplotype: ${d.haplotype}`),
        d3.select(".tooltip .tt_prefecture")
          .text(`Prefecture: ${pref47[d.prefecture].label}`),
        d3.select(".tooltip .tt_firstday")
          .text(`First day: ${d3.timeFormat("%Y-%m-%d")(d.firstday)}`),
        d3.select(".tooltip .tt_lastday")
          .text(`Last day: ${d3.timeFormat("%Y-%m-%d")(d.lastday)}`),
        d3.select(".tooltip .tt_duration")
          .text(`Duration: ${d.duration} day(s)`),
        d3.select(".tooltip .tt_total")
          .text(`Total: ${d.total} seq(s)/pref`)
      ]
      d3.select(".tooltip rect")
        .attr("width", 10 + d3.max(labels.map(d => d.node().getComputedTextLength())));
    }

    function hideTooltips(d) {
      d3.select(".tooltip").attr("opacity", 0);
    }

    function addEventHandlers() {
      d3.select("#haplotype")
        .on("change", toggleHaplotype);
      d3.select("#duration")
        .on("change", toggleDuration);
      d3.select("#haplolink")
        .on("change", toggleHaplolink);
    }

    function createHaplotypeMenu() {
      let haplotypes = Array.from(data.haplotypes);
      haplotypes.unshift("All");
      d3.select("#haplotype")
        .selectAll("option")
        .data(haplotypes)
        .join("option")
        .attr("value", d => d)
        .text(d => d);
    }

    function selectHaplotype(d) {
      let haplotype = d3.select("#haplotype").node().value;
      if (haplotype == "All") {
        return true;
      } else {
        return d.haplotype == haplotype ? true : false;
      }
    }

    function showAllOrSelected(selector) {
      d3.selectAll(selector).filter(d => selectHaplotype(d))
        .classed("show", true).classed("hide", false);
      d3.selectAll(selector).filter(d => ! selectHaplotype(d))
        .classed("show", false).classed("hide", true);
    }

    function hideAll(selector) {
      d3.selectAll(selector)
        .classed("show", false).classed("hide", true);
    }

    function toggleHaplotype() {
      showAllOrSelected(".firstday");
      toggleDuration();
      toggleHaplolink();
    }

    function toggleDuration() {
      if (d3.select("#duration").property("checked")) {
        showAllOrSelected(".duration");
        showAllOrSelected(".lastday");
      } else {
        hideAll(".duration");
        hideAll(".lastday");
      }
    }

    function toggleHaplolink() {
      if (d3.select("#haplolink").property("checked")) {
        drawHaplolink();
      } else {
        wipeHaplolink();
      }
    }
  </script>
  <style>
    text {
      font-family: sans-serif;
      font-size: 7pt;
    }
    .label {
      font-size: 9pt;
      text-anchor: middle;
    }
    .domain {
      opacity: 0;  /* hide X,Y axes */
    }
    .x-axis line, .y-axis line {
      stroke-width: .25;
/*
      stroke: rgba(114, 138, 74, 0.5);
*/
      opacity: 0.3;
    }
    .area {
      opacity: 0.2;
    }
    .show {
      opacity: 1;
    }
    .hide {
      opacity: 0;
    }
    .tooltip {
      pointer-events: none;
    }
    .tooltip text {
      font-size: 10pt;
    }
    .tooltip rect {
      fill: #eeeeee;
      fill-opacity: 0.7;
      stroke: #eeeeee;
      stroke-opacity: 0.7;
    }
  </style>
</head>

<body>

<div id="controller">
  Select haplotype: <select id="haplotype"></select>
  <input type="checkbox" id="duration"> Duration
  <input type="checkbox" id="haplolink" checked> Link
</div>
<!--svg width="100%" viewBox="0 0 10000 800" /-->
<!--svg width="100%" height="800" /-->
<svg width="7680" viewBox="0 0 7680 1000" />


</body>
</html>
