<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AY.29</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script>
    // JIS X 0401
    const pref47 = {
      Hokkaido:   { code: 1,  area: "東北", label: "北海道" },
      Aomori:     { code: 2,  area: "東北", label: "青森県" },
      Iwate:      { code: 3,  area: "東北", label: "岩手県" },
      Miyagi:     { code: 4,  area: "東北", label: "宮城県" },
      Akita:      { code: 5,  area: "東北", label: "秋田県" },
      Yamagata:   { code: 6,  area: "東北", label: "山形県" },
      Fukushima:  { code: 7,  area: "東北", label: "福島県" },
      Ibaraki:    { code: 8,  area: "関東", label: "茨城県" },
      Tochigi:    { code: 9,  area: "関東", label: "栃木県" },
      Gunma:      { code: 10, area: "関東", label: "群馬県" },
      Saitama:    { code: 11, area: "関東", label: "埼玉県" },
      Chiba:      { code: 12, area: "関東", label: "千葉県" },
      Tokyo:      { code: 13, area: "関東", label: "東京都" },
      Kanagawa:   { code: 14, area: "関東", label: "神奈川県" },
      Niigata:    { code: 15, area: "北陸", label: "新潟県" },
      Toyama:     { code: 16, area: "北陸", label: "富山県" },
      Ishikawa:   { code: 17, area: "北陸", label: "石川県" },
      Fukui:      { code: 18, area: "北陸", label: "福井県" },
      Yamanashi:  { code: 19, area: "東海", label: "山梨県" },
      Nagano:     { code: 20, area: "東海", label: "長野県" },
      Gifu:       { code: 21, area: "東海", label: "岐阜県" },
      Shizuoka:   { code: 22, area: "東海", label: "静岡県" },
      Aichi:      { code: 23, area: "東海", label: "愛知県" },
      Mie:        { code: 24, area: "東海", label: "三重県" },
      Shiga:      { code: 25, area: "関西", label: "滋賀県" },
      Kyoto:      { code: 26, area: "関西", label: "京都府" },
      Osaka:      { code: 27, area: "関西", label: "大阪府" },
      Hyogo:      { code: 28, area: "関西", label: "兵庫県" },
      Nara:       { code: 29, area: "関西", label: "奈良県" },
      Wakayama:   { code: 30, area: "関西", label: "和歌山県" },
      Tottori:    { code: 31, area: "中国", label: "鳥取県" },
      Shimane:    { code: 32, area: "中国", label: "島根県" },
      Okayama:    { code: 33, area: "中国", label: "岡山県" },
      Hiroshima:  { code: 34, area: "中国", label: "広島県" },
      Yamaguchi:  { code: 35, area: "中国", label: "山口県" },
      Tokushima:  { code: 36, area: "四国", label: "徳島県" },
      Kagawa:     { code: 37, area: "四国", label: "香川県" },
      Ehime:      { code: 38, area: "四国", label: "愛媛県" },
      Kochi:      { code: 39, area: "四国", label: "高知県" },
      Fukuoka:    { code: 40, area: "九州", label: "福岡県" },
      Saga:       { code: 41, area: "九州", label: "佐賀県" },
      Nagasaki:   { code: 42, area: "九州", label: "長崎県" },
      Kumamoto:   { code: 43, area: "九州", label: "熊本県" },
      Oita:       { code: 44, area: "九州", label: "大分県" },
      Miyazaki:   { code: 45, area: "九州", label: "宮崎県" },
      Kagoshima:  { code: 46, area: "九州", label: "鹿児島県" },
      Okinawa :   { code: 47, area: "九州", label: "沖縄県" },
    };

    /*
      Parameters
    */
    //const canvas = {width: 7680, height: 4320, magic: 11}
    //const canvas = {width: 7680, height: 1000, magic: 11}
    const canvas = {width: 2500, height: 1000, magic: 3}
    const margin = {top: 10, bottom: 90, left: 90, right: 10}
    const colors = d3.scaleOrdinal(d3.schemeTableau10);
    const scaleX = d3.scaleTime().range([margin.left, canvas.width - margin.right]);
    const scaleY = d3.scaleLinear().range([canvas.height - margin.bottom, margin.top]);
    const oneday = Date.parse("2022-03-10") - Date.parse("2022-03-09")
    const onerow = scaleY(2) - scaleY(1);

    // All data
    //const tsv = "ay29.tsv"
    // Subset data (n > 10)
    const tsv = "ay29_over10.tsv"

    /*
      Code
    */
    const data = { haplotypes: new Set() };

    d3.tsv(tsv, row => {
      data.haplotypes.add(row.haplotype);
      return {
        haplotype: row.haplotype,
        firstday: Date.parse(row.first),
        lastday: Date.parse(row.last),
        duration: parseInt(row.duration),
        total: parseInt(row.total),
        prefecture: row.prefecture
      }
    }).then(dataset => {
      data.selected = Array.from(data.haplotypes);
      data.points = dataset;
      scaleX.domain([
        d3.min(dataset, d => d.firstday) - oneday,
        d3.max(dataset, d => d.lastday) + oneday
      ]);
      scaleY.domain(
        d3.extent(dataset, d => pref47[d.prefecture].code)
      );
      draw();
    });

    function draw() {
      addEventHandlers();
      createHaplotypeMenu();
      placeInfobox();
      drawArea();
      drawAxes();
      drawHaplolink();
      drawHaplotype();
    }

    function addEventHandlers() {
      d3.select("#haplotype")
        .on("change", changeHaplotype);
      d3.select("#duration")
        .on("change", changeDuration);
      d3.select("#haplolink")
        .on("change", changeHaplolink);
    }

    function createHaplotypeMenu() {
      let options = Array.from(data.haplotypes);
      options.unshift("All");
      d3.select("#haplotype")
        .selectAll("option")
        .data(options)
        .join("option")
        .attr("value", d => d)
        .text(d => d);
    }

    function placeInfobox() {
      d3.select("#infobox").style("margin-left", `${margin.left}px`);
    }

    function drawArea() {
      areas = [
        {
          name: "tohoku",
          y1: scaleY(48 - pref47["Hokkaido"].code),
          y2: scaleY(48 - pref47["Fukushima"].code - 1)
        },
        {
          name: "kanto",
          y1: scaleY(48 - pref47["Ibaraki"].code),
          y2: scaleY(48 - pref47["Kanagawa"].code - 1)
        },
        {
          name: "hokuriku",
          y1: scaleY(48 - pref47["Niigata"].code),
          y2: scaleY(48 - pref47["Fukui"].code - 1)
        },
        {
          name: "tokai",
          y1: scaleY(48 - pref47["Yamanashi"].code),
          y2: scaleY(48 - pref47["Mie"].code - 1)
        },
        {
          name: "kansai",
          y1: scaleY(48 - pref47["Shiga"].code),
          y2: scaleY(48 - pref47["Wakayama"].code - 1)
        },
        {
          name: "chugoku",
          y1: scaleY(48 - pref47["Tottori"].code),
          y2: scaleY(48 - pref47["Yamaguchi"].code - 1)
        },
        {
          name: "shikoku",
          y1: scaleY(48 - pref47["Tokushima"].code),
          y2: scaleY(48 - pref47["Kochi"].code - 1)
        },
        {
          name: "kyushu",
          y1: scaleY(48 - pref47["Fukuoka"].code),
          y2: scaleY(48 - pref47["Okinawa"].code - 1)
        }
      ]
      for (let area of areas) {
        d3.select("svg")
          .append("rect")
          .attr("class", "area")
          .attr("x", margin.left)
          .attr("y", area.y1 + (scaleY(2) - scaleY(1)) / 2)
          .attr("width", canvas.width - (margin.left + margin.right))
          .attr("height", area.y2 - area.y1)
          .attr("fill", colors(area.name));
      }
    }

    function drawAxes() {
      const axisX = d3.axisBottom(scaleX)
        .ticks(200)
        .tickSize(0)
        .tickFormat(d3.timeFormat("%Y-%m-%d"));
      const axisXgrid = d3.axisBottom(scaleX)
        .ticks(200)
        .tickSize(canvas.height - margin.bottom + 10);
      const axisY = d3.axisLeft(scaleY)
        .tickPadding(5)
        .ticks(50, "c")
        .tickSize(0)
        .tickFormat(d => {
          for (let pref in pref47) {
            if (pref47[pref].code == 48 - d) {
              return pref47[pref].label
            }
          }
        });
      const axisYgrid = d3.axisLeft(scaleY)
        .ticks(50, "c")
        .tickSize(canvas.width - (margin.left + margin.right));

      // X axis label
      d3.select("svg")
        .append("g")
        .attr("class", "axis-x")
        .call(axisX)
        // rotate X label
        .selectAll("text")
        .style("text-anchor", "start")
        .attr("transform", "rotate(90)")
        .attr("x", canvas.height - margin.bottom)
        .attr("y", 0)
        .attr("dx", "1.5em")   // padding
        .attr("dy", ".35em");  // base line
      // X axis grid
      d3.select("svg")
        .append("g")
        .attr("class", "axis-x-grid")
        .call(axisXgrid)
        .selectAll("text").remove();
      // Y axis label
      d3.select("svg")
        .append("g")
        .attr("class", "axis-y")
        .attr("transform", `translate(${[margin.left, 0]})`)
        .call(axisY);
      // Y axis grid
      d3.select("svg")
        .append("g")
        .attr("class", "axis-y-grid")
        .attr("transform", `translate(${[canvas.width - margin.right, 0]})`)
        .call(axisYgrid)
        .selectAll("text").remove();
    }

    function drawHaplotype(r = 5, w = 2) {
      let points = data.points.filter(d => data.selected.includes(d.haplotype));
      wipeHaplotype();
      drawDuration(points, w);
      drawFirstday(points, r);
      drawLastday(points, r);
      changeDuration();
    }

    function wipeHaplotype() {
      wipeSelector(".firstday");
      wipeSelector(".lastday");
      wipeSelector(".duration");
    }

    function drawDuration(points, w) {
      for (let point of points) {
        d3.select("svg")
          .append("path")
          .datum(point)
          .attr("class", "duration")
          .attr("fill", "none")
          .attr("stroke", colors(point.haplotype))
          //.attr("stroke-width", w)
          .attr("stroke-width", d => Math.log(d.total))
          .attr("d", duration(point))
          .on("mouseover", showInfobox)
          .on("click", d => toggleHaplotype(d.haplotype));
      }
    }

    function duration(d) {
      x1 = scaleX(d.firstday) - canvas.magic;
      x2 = scaleX(d.lastday) - canvas.magic;
      y = scaleY(48 - pref47[d.prefecture].code);
      return d3.line()([[x1,y], [x2,y]]);
    }

    function changeDuration() {
      if (d3.select("#duration").property("checked")) {
        showSelector(".duration");
        showSelector(".lastday");
      } else {
        hideSelector(".duration");
        hideSelector(".lastday");
      }
    }

    function drawFirstday(points, r) {
      d3.select("svg")
        .selectAll("circle.firstday")
        .data(points)
        .join("circle")
        .attr("class", "firstday")
        .attr("r", r)
        .attr("cx", d => scaleX(d.firstday) - canvas.magic)
        .attr("cy", d => scaleY(48 - pref47[d.prefecture].code))
        .on("click", d => toggleHaplotype(d.haplotype))
        .on("mouseover", showInfobox);
      d3.selectAll(".firstday")
        .style("fill", d => colors(d.haplotype));
    }

    function drawLastday(points, r) {
      d3.select("svg")
        .selectAll("circle.lastday")
        .data(points)
        .join("circle")
        .attr("class", "lastday")
        .attr("r", r)
        .attr("cx", d => scaleX(d.lastday) - canvas.magic)
        .attr("cy", d => scaleY(48 - pref47[d.prefecture].code))
        .on("click", d => toggleHaplotype(d.haplotype))
        .on("mouseover", showInfobox);
      d3.selectAll(".lastday")
        .style("fill", d => colors(d.haplotype));
    }

    function toggleHaplotype(haplotype) {
      if (data.selected[0] == haplotype && ! data.selected[1]) {
        data.selected = Array.from(data.haplotypes);
      } else {
        data.selected = [ haplotype ];
      }
      drawHaplolink();
      drawHaplotype();
    }

    function changeHaplotype() {
      data.selected = Array.from(this.options).filter(d => d.selected).map(d => d.value);
      if (data.selected.includes("All") || data.selected.size == 0) {
        data.selected = Array.from(data.haplotypes);
      }
      drawHaplolink();
      drawHaplotype();
    }

    function drawHaplolink() {
      wipeHaplolink();
      for (haplotype of data.selected) {
        let haplopoints = data.points.filter(d => d.haplotype == haplotype);
        d3.select("svg")
          .append("path")
          .datum(haplopoints)
          .join("path")
          .attr("class", "haplolink")
          .attr("fill", "none")
          .attr("stroke", d3.rgb("#cccccc"))
          .attr("d", haplolink(haplopoints));
      }
    }

    function wipeHaplolink() {
      wipeSelector(".haplolink");
    }

    function haplolink() {
      return d3.line()
        .x(d => scaleX(d.firstday) - canvas.magic)
        .y(d => scaleY(48 - pref47[d.prefecture].code));
    }

    function changeHaplolink() {
      wipeHaplolink();
      if (d3.select("#haplolink").property("checked")) {
        drawHaplolink();
        drawHaplotype();
      }
    }

    function toggleHaplolink() {
      if (d3.select("#haplolink").property("checked")) {
        drawHaplolink();
      } else {
        wipeHaplolink();
      }
    }

    function showInfobox(d) {
      d3.select("#info_haplotype")
        .text(d.haplotype);
      d3.select("#info_prefecture")
        .text(pref47[d.prefecture].label);
      d3.select("#info_firstday")
        .text(d3.timeFormat("%Y-%m-%d")(d.firstday));
      d3.select("#info_lastday")
        .text(d3.timeFormat("%Y-%m-%d")(d.lastday));
      d3.select("#info_duration")
        .text(`${d.duration} day(s)`);
      d3.select("#info_total")
        .text(`${d.total} seq(s)/pref`);
    }

    function showSelector(selector) {
      d3.selectAll(selector)
        .classed("show", true).classed("hide", false);
    }

    function hideSelector(selector) {
      d3.selectAll(selector)
        .classed("show", false).classed("hide", true);
    }

    function wipeSelector(selector) {
      d3.selectAll(selector).remove();
    }
  </script>
  <style>
    text {
      font-family: sans-serif;
      font-size: 7pt;
    }
    .label {
      font-size: 9pt;
      text-anchor: middle;
    }
    .domain {
      opacity: 0;  /* hide X,Y axes */
    }
    .axis-x line, .axis-y line {
      stroke-width: .25;
    }
    .axis-x-grid line, .axis-y-grid line {
      stroke-width: .25;
      opacity: 0.3;
    }
    svg .area {
      opacity: 0.2;
    }
    .show {
      opacity: 1;
    }
    .hide {
      opacity: 0;
    }
    /* .tooltip seems to be taken by bootstrap */
    .haplotip {
      pointer-events: none;
    }
    .haplotip text {
      font-size: 10pt;
    }
    .haplotip rect {
      fill: #eeeeee;
      fill-opacity: 0.7;
      stroke: #eeeeee;
      stroke-opacity: 0.7;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-light bg-light">
    <div class="container-fluid">
      <span class="navbar-brand">
        <i class="bi-bar-chart-steps" style="font-size: 1.4rem;"></i>
        COVID-19 AY.29
      </span>

      <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle" type="button" id="dropdown-haplotype" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi-node-plus-fill" style="font-size: 1.2rem;"></i>
          Select AY.29 haplotype(s)
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdown-haplotype" style="opacity: 0.8;">
          <li>
            <div class="info" style="margin: 10px;">
              <i class="bi-info-circle-fill info" style="color: #007bff;"></i>
              Multiple choice:<br/>
              <i class="bi-apple" style="color: #6c757d;">Cmd</i> / <i class="bi-windows" style="color: #6c757d;">Ctrl</i> + <i class="bi-mouse2" style="color: #6c757d;">Click</i>
            </div>
            <select id="haplotype" class="form-select" style="border: none; padding: 10px" size="30" multiple></select>
          </li>
        </ul>
      </div>

      <span class="text-secondary">Best viewed with a screen resolution of > 2500x1200</span>

      <form class="d-flex">
        <div class="form-check form-check-inline form-switch">
          <input type="checkbox" id="duration" class="form-check-input">
          <label class="form-check-label" for="duration">Duration</label>
        </div>
        <div class="form-check form-check-inline form-switch">
          <input type="checkbox" id="haplolink" class="form-check-input" checked>
          <label class="form-check-label" for="haplolink">Haplolink</label>
        </div>
      </form>
    </div>
  </nav>
  <div id="infobox" class="btn-group" role="group" aria-label="Infobox" style="margin: 10px">
    <button type="button" class="btn btn-outline-secondary">
      Haplotype
      <span id="info_haplotype" class="badge bg-light text-dark">1</span>
    </button>
    <button type="button" class="btn btn-outline-secondary">
      Prefecture
      <span id="info_prefecture" class="badge bg-light text-dark">神奈川県</span>
    </button>
    <button type="button" class="btn btn-outline-secondary">
      First day
      <span id="info_firstday" class="badge bg-light text-dark">2021-05-18</span>
    </button>
    <button type="button" class="btn btn-outline-secondary">
      Last day
      <span id="info_lastday" class="badge bg-light text-dark">2021-09-21</span>
    </button>
    <button type="button" class="btn btn-outline-secondary">
      Duration
      <span id="info_duration" class="badge bg-light text-dark">127 day(s)</span>
    </button>
    <button type="button" class="btn btn-outline-secondary">
      Total
      <span id="info_total" class="badge bg-light text-dark">198 seq(s)/pref</span>
    </button>
  </div>
  <!--svg width="100%" viewBox="0 0 10000 800" /-->
  <!--svg width="100%" height="800" /-->
  <svg width="2500" viewBox="0 0 2500 1000" />
</body>
</html>
